# Хранение картографических данных в СУБД PostgreSQL и реализация поиска объектов на карте с применением расширения PostGIS

## Подготовка

### Создание ВМ
Для выполнения ДЗ будем использовать **VirtualBox** и образ **Ubuntu 22.04 LTS**, они доступны бесплатно по первой ссылке в гугле.  
Для запуска ОС потребуется:  
1. Скачать образ Ubuntu 22.04.4 LTS отсюда: https://ubuntu.com/download/desktop  
2. Установить VirtualBox отсюда: https://www.virtualbox.org/wiki/Downloads  
3. Открыть VirtualBox  
4. Нажать в главном меню Машина > Создать  
5. Открыть раздел "Имя и тип ОС"  
5.1. В выпадающем списке "Образ ISO" выбрать "Другой" и указать скачанный ранее iso-образ  
5.2. В выпадающем списке "Тип" выбрать "Linux"  
5.3. В выпадающем списке "Версия" выбрать "Ubuntu 22.04 LTS (Jammy Jellyfish) (64-bit)"  
5.4. В поле "Имя" ввести любое имя  
6. Открыть раздел "Автоматическая установка"  
6.1. В поле "Имя хоста" указать любое корректное имя без пробелов  
6.2. В полях "Пароль" и "Подтвердите пароль" задать пароль, либо нажать на глаз и запомнить пароль, который там был  
7. Открыть раздел "Оборудование"  
7.1 Выбрать Основную память 8192 МБ  
7.2 Выбрать 2 процессора  
8. Открыть раздел "Жёсткий диск"  
8.1 В разделе "Расположение и размер файла жёсткого диска" выбрать 25 ГБ  
9. Нажать кнопку "Готово"  
10. Подождать, пока установится ОС  
11. Пропустить все вопросы, связанные с настройкой, после запуска ОС  
12. Терминал при этом не открывается, поэтому нужно зайти в Settings > Region > Language > Login Screen > явным образом выбрать English (United States) без ISO-8859-1 и перезагрузить ОС (см. https://ru.stackoverflow.com/questions/1476869/%D0%9D%D0%B5-%D0%BC%D0%BE%D0%B3%D1%83-%D0%BE%D1%82%D0%BA%D1%80%D1%8B%D1%82%D1%8C-%D1%82%D0%B5%D1%80%D0%BC%D0%B8%D0%BD%D0%B0%D0%BB-%D0%B2-ubuntu)  
13. Админских прав у пользователя не будет, поэтому нужно (см. https://youtu.be/jZGHtuxpaP4?si=X6mA74Qdt00wUaw6):  
13.1. Ввести команду su  
13.2. Ввести пароль текущего пользователя  
13.3. Ввести команду usermod -aG sudo vboxuser  
13.4. Перезагрузить ОС, например, командой reboot  
14. Даже если настроить в VirtualBox двунаправленный буфер обмена, он работать не будет. Чтобы это исправить, нужно:  
14.1. Скачать образ https://download.virtualbox.org/virtualbox/6.1.2/VBoxGuestAdditions_6.1.2.iso  
14.2. Смонтировать образ, например, открыв его в папке, с помощью двойного клика  
14.3. Открыть терминал в папке смонтированного образа  
14.4. Выполнить команду sudo sh VBoxLinuxAdditions.run  
14.5. Перезагрузить ОС  
14.6. После этого на экране ВМ будут постоянно появляться странные артефакты, но по крайней мере заработает общий буфер обмена. Можно подобрать размер окна ВМ, при котором проблема пропадает.

### Установка PostgreSQL 15

В этом поможет следующий набор команд:
```
sudo apt update && sudo apt upgrade -y -q && sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list' && wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add - && sudo apt-get update && sudo apt -y install postgresql-15
```
Появится длинный лог установки, можем его пропустить.

### Установка postgis:
```
sudo apt install postgis
```

### Установка pgAdmin

Данный пункт нужен для удобства выполнения запросов, как альтернатива консоли. В дальнейших пунктах он не используется.  

Устанавливаем curl:
```
sudo apt install curl
```

Устанавливаем публичный ключ для репозитория (если это не сделано ранее):
```
curl -fsS https://www.pgadmin.org/static/packages_pgadmin_org.pub | sudo gpg --dearmor -o /usr/share/keyrings/packages-pgadmin-org.gpg
```

Создаём конфигурационный файл репозитория:
```
sudo sh -c 'echo "deb [signed-by=/usr/share/keyrings/packages-pgadmin-org.gpg] https://ftp.postgresql.org/pub/pgadmin/pgadmin4/apt/$(lsb_release -cs) pgadmin4 main" > /etc/apt/sources.list.d/pgadmin4.list && apt update'
```

Устанавливаем pgAdmin:
```
sudo apt install pgadmin4
```

### Создание БД для хранения картографических данных

Заходим в psql:
```
sudo -u postgres psql
```

Выполняем команды:
```sql
create database gisdb;                   -- Создаём БД gisdb
\connect gisdb;                          -- Подключаемся к созданной БД
create schema postgis;                   -- Создаём схему postgis
create extension postgis schema postgis; -- Добавляем расширение postgis в схему postgis
```

Также нужно позволить обращаться к функциям postgis без указания схемы (иначе могут быть проблемы при импорте карт):
```sql
alter database gisdb set search_path = "$user", public, lookup, postgis;
set search_path to postgis;
```

Теперь в БД можно пользоваться картографическими функциями.

Например, можем запросить версии библиотек postgis:
```sql
select postgis_full_version();
```

В консоль выведется:
```
postgis_full_version                                                                        
--------------------
 POSTGIS="3.2.0 c3e3cc0" [EXTENSION] PGSQL="140" GEOS="3.10.2-CAPI-1.16.0" PROJ="8.2.1" LIBXML="2.9.12" LIBJSON="0.15" LIBPROTOBUF="1.3.3" WAGYU="0.5.0 (Internal)"
(1 row)
```

### Заполнение БД данными

1. Заходим в браузер по ссылке на сайт OpenStreetMap:  
https://www.openstreetmap.org/export#map=15/59.9341/30.3198

На карте отображается центр Санкт-Петербурга. Весь город выгрузить не пытаемся, т.к. есть ограничение на размер карты, после которого нужно будет качать из других источников (а также, чтобы не качать несколько гигабайт и не усложнять тестирование).  

**Важно!** В зависимости от размера окна браузера попадающие в видимую область объекты будут отличаться. По возможности нужно выбрать окно максимального размера и отзумиться подальше. Если при выгрузке будут возникать ошибки - возвращаемся, зумимся ближе и снова пытаемся выгрузить. Дальнейшее описание запросов к SQL основано на том, что нужные объекты попали в видимую область.

2. Нажимаем кнопку Export.
3. Заходим в папку загрузок и открываем в ней терминал
4. Устанавливаем помощник импорта карт из формата osm в БД postgresql:
```
sudo apt install osm2pgsql
```
5. Импортируем карту в базу gisdb с предустановленным расширением postgis:
```
sudo -u postgres osm2pgsql -d gisdb map.osm
```


### Просмотр картографических данных, хранящихся в БД PostgreSQL

Для просмотра картографических данных будем использовать свободно распространяемый редактор QGIS.  
Устанвливаем его командой:
```
sudo apt install qgis
```

Открываем QGIS и загружаем карту:  
1. Создаём новый проект нажатием на кнопку с белым листом (New Project)  
2. В меню нажимаем на кнопку с тремя разноцветными квардатами "Open Data Source Manager"  
3. В левом меню выбираем PostgreSQL  
4. В разделе Connections нажимаем кнопку New  
5. Настраиваем подключение:  
5.1 В поле Name указываем SPB  
5.2 В поле Host указываем localhost  
5.3 В поле Post указываем 5432  
5.4 В поле Database указываем gisdb  
5.5 В разделе Authentication переходим на вкладку Basic  
5.6 В поле User name указываем postgres  
5.7 В поле Password указываем пароль пользователя postgres (если не знаем, сменить можно командой psql ```\password postgres```)  
5.8 Нажимаем Convert to configuration  
5.9 Вводим пароль для конфигурации и повторяем его во втором поле  
5.10 Нажимаем Ок  
6. Нажимаем Connect  
7. Раскрываем схему public  
8. Проходим двойным кликом по каждой строке, чтобы добоавить все слои на карту  
9. Нажимаем Close  

На экране появится карта, можем по ней перемещаться, зумиться и т.д.  

### Поиск объектов через SQL-запросы

Попробуем сделать квадрат для поиска объектов с координатами.  
Для наглядности будем использовать систему координат WGS84, в которой широта и долгота указываются в градусах.  
В QGIS жмём правой кнопкой по точке и выбираем "Copy coordinate" -> "WGS84":  
Левая верхняя точка: 30.314294,59.933514
Правая нижняя точка: 30.316969,59.932562

Для поиска понадобится описать полигон в формате **WKT** (Well-Known Text).  
Нужно учесть следующие моменты:  
* Полигон может состоять из нескольких фигур, каждая из которых будет в отдельных скобках. В нашем случае фигура одна, следовательно скобки двойные.  
* Для квадрата потребуется 5 точек - 5я должна совпадать с первой, иначе будет ошибка, что полигон имеет незакрытые кольца.
* При сравнении геометрий нужно, чтобы системы координат совпадали. Следовательно, нужно указывать, в какой системе координат передаётся геометрия и преобразовывать геометрию в систему координат карты.  

#### Определяем систему координат объектов в БД:

Посмотрим, какая система координат у геометрий дорог:
```sql
select Find_SRID('postgis', 'planet_osm_roads', 'way');
```
В консоль выведется **3857**.

#### Проверка корректности геометрии

Будем использовать систему координат WGS84 (4326), в которой QGIS копирует 
Для проверки, что геометрия описана корректно, можно воспользоваться функцией ST_GeomFromText():
```sql
select ST_GeomFromText('POLYGON((30.314294 59.933514,30.316969 59.933514,30.316969 59.932562,30.314294 59.932562, 30.314294 59.933514))', 4326);
```
В консоль выведется:
```
st_geomfromtext
----------------
0103000020110F000001000000050000003B54539275503E40D82D02637DF74D4088D860E124513E40D82D02637DF74D4088D860E124513E4005BF0D315EF74D403B54539275503E4005BF0D315EF74D403B54539275503E40D82D02637DF74D40
(1 row)
```
Так как ошибок нет, геометрия описана корректно.  
 

#### Поиск объектов на карте

Попробуем запросить объекты в заданном квадрате:

```sql
select name from planet_osm_polygon where 
st_intersects (
   planet_osm_polygon.way,
        ST_Transform(
              ST_GeomFromText('POLYGON((30.314294 59.933514,30.316969 59.933514,30.316969 59.932562,30.314294 59.932562, 30.314294 59.933514))', 4326) -- система координат полигона 4326
			  , 3857) -- система координат геометрий в БД
)
and name is not null
limit 10;
```

В консоль выведется:
```
                                   name                                    
---------------------------------------------------------------------------
 Российский государственный педагогический университет имени А. И. Герцена
 Бизнес-центр «У Красного моста»
 Красный мост
(3 rows)
```

Видим, что найдено несколько объектов, пересекающихся с заданным квардатом.  
Если системы координат совпадают, можно обойтись без ST_Transform.  
Таким образом, если мы хотим, например, найти все объекты в указанном районе, нужно сначала найти этот район в БД, получить его геометрию, а затем использовать указанный выше запрос.  

Получить WKT геометрии из БД можно так:
```sql
select ST_AsText(way) from planet_osm_line limit 1;
```
В консоли увидим WKT:
```
st_astext
--------------------
LINESTRING(3375694.840784354 8386637.179324647,3375652.3278708206 8386693.962736382,3375604.8835038445 8386757.369544521,3375571.643503893 8386802.952553703,3375569.662016957 8386805.041689111,3375567.4022312937 8386806.308505548,3375564.8641469036 8386806.508529214,3375562.448513954 8386805.841783681,3375552.0846693614 8386801.596838493,3375469.5301349885 8386765.659363829,3375420.7054063263 8386744.92372071,3375405.877650153 8386735.3448956255,3375358.422151228 8386700.163378094,3375303.6084339614 8386656.225610069,3375287.956913556 8386642.179803213,3375269.5558017273 8386621.400058956,3375250.286397872 8386597.108945568,3375207.996123319 8386539.459542238,3375205.1352124056 8386532.125610395,3375187.2684341334 8386484.944156682,3375186.812024221 8386468.965202453,3375185.1978916046 8386395.649137581,3375185.0309123686 8386387.426405253,3375184.752613641 8386378.848105096,3375183.249800516 8386332.534346164,3375181.5466123065 8386320.844834976)
(1 row)
```
