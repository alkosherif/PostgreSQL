# Виды индексов. Работа с индексами и оптимизация запросов 	

## Подготовка

### Создание ВМ
Для выполнения ДЗ будем использовать **VirtualBox** и образ **Ubuntu 22.04 LTS**, они доступны бесплатно по первой ссылке в гугле.  
Для запуска ОС потребуется:  
1. Скачать образ Ubuntu 22.04.4 LTS отсюда: https://ubuntu.com/download/desktop  
2. Установить VirtualBox отсюда: https://www.virtualbox.org/wiki/Downloads  
3. Открыть VirtualBox  
4. Нажать в главном меню Машина > Создать  
5. Открыть раздел "Имя и тип ОС"  
5.1. В выпадающем списке "Образ ISO" выбрать "Другой" и указать скачанный ранее iso-образ  
5.2. В выпадающем списке "Тип" выбрать "Linux"  
5.3. В выпадающем списке "Версия" выбрать "Ubuntu 22.04 LTS (Jammy Jellyfish) (64-bit)"  
5.4. В поле "Имя" ввести любое имя  
6. Открыть раздел "Автоматическая установка"  
6.1. В поле "Имя хоста" указать любое корректное имя без пробелов  
6.2. В полях "Пароль" и "Подтвердите пароль" задать пароль, либо нажать на глаз и запомнить пароль, который там был  
7. Открыть раздел "Оборудование"  
7.1 Выбрать Основную память 8192 МБ  
7.2 Выбрать 2 процессора  
8. Открыть раздел "Жёсткий диск"  
8.1 В разделе "Расположение и размер файла жёсткого диска" выбрать 25 ГБ  
9. Нажать кнопку "Готово"  
10. Подождать, пока установится ОС  
11. Пропустить все вопросы, связанные с настройкой, после запуска ОС  
12. Терминал при этом не открывается, поэтому нужно зайти в Settings > Region > Language > Login Screen > явным образом выбрать English (United States) без ISO-8859-1 и перезагрузить ОС (см. https://ru.stackoverflow.com/questions/1476869/%D0%9D%D0%B5-%D0%BC%D0%BE%D0%B3%D1%83-%D0%BE%D1%82%D0%BA%D1%80%D1%8B%D1%82%D1%8C-%D1%82%D0%B5%D1%80%D0%BC%D0%B8%D0%BD%D0%B0%D0%BB-%D0%B2-ubuntu)  
13. Админских прав у пользователя не будет, поэтому нужно (см. https://youtu.be/jZGHtuxpaP4?si=X6mA74Qdt00wUaw6):  
13.1. Ввести команду su  
13.2. Ввести пароль текущего пользователя  
13.3. Ввести команду usermod -aG sudo vboxuser  
13.4. Перезагрузить ОС, например, командой reboot  
14. Даже если настроить в VirtualBox двунаправленный буфер обмена, он работать не будет. Чтобы это исправить, нужно:  
14.1. Скачать образ https://download.virtualbox.org/virtualbox/6.1.2/VBoxGuestAdditions_6.1.2.iso  
14.2. Смонтировать образ, например, открыв его в папке, с помощью двойного клика  
14.3. Открыть терминал в папке смонтированного образа  
14.4. Выполнить команду sudo sh VBoxLinuxAdditions.run  
14.5. Перезагрузить ОС  
14.6. После этого на экране ВМ будут постоянно появляться странные артефакты, но по крайней мере заработает общий буфер обмена. При изменении размеров окна ВМ проблема пропадает.

### Установка PostgreSQL 15

В этом поможет следующий набор команд:
```
sudo apt update && sudo apt upgrade -y -q && sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list' && wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add - && sudo apt-get update && sudo apt -y install postgresql-15
```
Появится длинный лог установки, можем его пропустить.

### Наполнение данными
Заходим в psql:

```
sudo -u postgres psql
```

В консоль выведется:
```
psql (15.6 (Ubuntu 15.6-1.pgdg22.04+1))
Type "help" for help.
```

#### Создадим три таблицы - Artists (Исполнитель), Albums (Альбом) и Songs (Песня).  

```sql

create table artists (
    Id serial primary key,
    Name varchar(100) not null,
    Description varchar(2000) not null    
);

create table albums (
    Id serial primary key,
    ArtistId int not null,
    Name varchar(100) not null,
    Genre varchar(50) not null,
    Year int not null,
    constraint fk_artist
      foreign key(ArtistId) 
        references artists(Id)
);

create table songs (
    Id serial primary key,
    AlbumId int not null,
    Name varchar(100) not null,
    Text varchar(5000) not null,
    constraint fk_album
      foreign key(AlbumId) 
        references albums(Id)
);
```

В консоли на каждую таблицу выведется:
```
CREATE TABLE
```

#### Добавим немного правдоподобных данных

Для тестирования полнотекстового поиска добавим немного правдоподобных данных, а затем нагенерируем остальные.  

```sql
-- Заполним таблицу исполнителей:
insert into artists (Name, Description) values
('Вячеслав Григорьевич Добрынин', 'Советский и российский композитор, эстрадный певец; народный артист Российской Федерации (1996), лауреат премии Ленинского комсомола (1986).'),
('Тима Белорусских', 'Тимофе́й Андре́евич Моро́зов, более известный как Ти́ма Белору́сских, — белорусский певец, автор песен, композитор и музыкант.'),
('Каста', '«Ка́ста» — российская рэп-группа из Ростова-на-Дону, артисты лейбла Respect Production.'),
('Ария', '«А́рия» — советская и российская хеви-метал-группа.');

-- Добавим альбомы:
insert into albums (ArtistId, Name, Genre, Year) values
(1, 'Синий туман', 'русская поп-музыка', 1989),
(2, 'Незабудка', 'русская поп-музыка', 2018),
(3, 'Ясно!', 'русский рэп', 2012),
(4, 'Химера', 'хэви-метал', 2001);

-- Добавим песни:
insert into songs (AlbumId, Name, Text) values
(1, 'Бабушки-старушки', 'Бабушки, бабушки, бабушки старушки\r\nБабушки, бабушки, ушки на макушке\nБабушки, бабушки, мы вас уважаем\nТолько как вас понять, мы, увы, не знаем\n'),
(1, 'Незабудка', 'Незабудка, незабудка, иногда одна минутка,\nИногда одна минутка значит больше чем года.\nНезабудка, незабудка, в сказке я живу как будто,\nИ тебя я, незабудка, не забуду никогда.'),
(2, 'Незабудка', 'Незабудка — твой любимый цветок\nВоздушный поцелуй станет самым горьким\nТы любишь говорить, что я тебя не люблю\nЧто любить смогут одни девчонки'),
(3, 'Сочиняй мечты', 'Тогда сочиняй мечты,\nЕсть миллионы шансов, что скоро будет все сбываться\nСочиняй мечты,\nЕсть миллионы шансов, что скоро будет все сбываться.'),
(4, 'Осколок льда', 'Я любил и ненавидел\nНо теперь душа пуста\nВсё исчезло, не оставив и следа\nИ не знает боли в груди осколок льда');
```

В консоль выведется:
```
INSERT 0 4
INSERT 0 4
INSERT 0 5
```

#### Разбавим сгенерированными данными
Добавим расширение для геренации uuid:
```sql
create extension "uuid-ossp";
```
В консоль выведется:
```
CREATE EXTENSION
```

Добавим данные:
```sql
insert into artists (Name, Description) 
select uuid_generate_v4()::text, uuid_generate_v4()::text from generate_series(1, 1000) as index;

insert into albums (ArtistId, Name, Genre, Year) 
select 1 + random() * 1000, uuid_generate_v4()::text, uuid_generate_v4()::text, 2024 - (random() * 30) from generate_series(1, 10000) as index;

insert into songs (AlbumId, Name, Text) 
select 1 + random() * 10000, uuid_generate_v4()::text, uuid_generate_v4()::text from generate_series(1, 100000) as index;
```

В консоль выведется:
```sql
INSERT 0 1000
INSERT 0 10000
INSERT 0 100000
```

## Выполнение ДЗ

### Создать индекс к какой-либо из таблиц вашей БД
### Прислать текстом результат команды explain, в которой используется данный индекс
### Реализовать индекс для полнотекстового поиска
### Реализовать индекс на часть таблицы или индекс на поле с функцией
### Создать индекс на несколько полей
### Написать комментарии к каждому из индексов
### Описать что и как делали и с какими проблемами столкнулись
