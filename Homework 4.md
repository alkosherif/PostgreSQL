# Логический уровень PostgreSQL. Работа с базами данных, пользователями и правами

## Подготовка

### Создание ВМ

1. Заходим в Yandex.Cloud
2. Выбираем Все сервисы > Compute Cloud > Создать ВМ
3. Создаём сеть:  
3.1. В поле Каталог указываем "default"  
3.2. В поле "Имя" "otus-vm-db-pg-net-1"  
3.3. Выбираем "Создать подсети"  
3.4. Нажимаем "Создать"  
4. Заполняем имя ВМ "otus-db-pg-vm-1"
5. В поле "Зона доступности" указываем "ru-central1-d"
6. В разделе "Операционные системы" выбираем "Ubuntu 20.04"
7. В поле "RAM" ставим "4 ГБ"
8. В поле "Логин" указываем **otus**  
9. В поле "SSH-ключ" указываем публичный ключ:  
9.1. Если не генерировали SSH-ключ ранее:  
9.1.1. Заходим в PuttyGen  
9.1.2. Нажимаем "Generate"  
9.1.3. Генерируем ключи, двигая мышкой по пустой области  
9.1.4. Сохраняем публичный и приватный ключи в отдельную папку  
9.1.5. Копируем текст из поля Key (Public key for pasting into Open SSH authorized_keys file)  
9.1.6. Вставляем в поле "SSH-ключ"  
9.2. Если уже есть сгенерированный ключ:  
9.2.1. Правый клик по файлу *.ppk > Edit with PuTTYGen  
9.2.2. Копируем текст из поля Key (Public key for pasting into Open SSH authorized_keys file)  
9.2.3. Вставляем в поле "SSH-ключ"  
10. Проставляем галочку "Разрешить доступ к серийной консоли"  
11. Нажимаем "Создать ВМ"  
12. В открывшемся окне ждём завершения создания ВМ и **сохраняем публичный IPv4 (158.160.138.140)**  

### Подключение к ВМ через Putty

1. Подгружаем двойным кликом *.ppk, чтобы использовать ключи для подключения
2. Открываем Putty
3. В поле Host Name указываем внешний IPv4, полученный при создании ВМ (в пункте 12)
4. Нажимаем Open
5. В появившемся окне выбираем Accept
6. На запрос логина вводим логин, указанный при создании ВМ (в пункте 8)  
  
Теперь можно выполнять команды.

### Установка и подключение к PostgreSQL:
```
sudo apt update && sudo apt upgrade -y -q && sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list' && wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add - && sudo apt-get update && sudo apt -y install postgresql-15
```

Проверяем, что установка прошла успешно:
```
pg_lsclusters
```

В консоли выведется:
```
Ver Cluster Port Status Owner    Data directory              Log file
15  main    5432 online postgres /var/lib/postgresql/15/main /var/log/postgresql/postgresql-15-main.log
```

**Подключаемся к PostgreSQL**:
```
sudo -u postgres psql
```

## Задания

### 1. Создайте новый кластер PostgresSQL 14
### 2. Зайдите в созданный кластер под пользователем postgres
### 3. Создайте новую базу данных testdb
### 4. Зайдите в созданную базу данных под пользователем postgres
### 5. Создайте новую схему testnm
### 6. Создайте новую таблицу t1 с одной колонкой c1 типа integer
### 7. Вставьте строку со значением c1=1
### 8. Создайте новую роль readonly
### 9. Дайте новой роли право на подключение к базе данных testdb
### 10. Дайте новой роли право на использование схемы testnm
### 11. Дайте новой роли право на select для всех таблиц схемы testnm
### 12. Создайте пользователя testread с паролем test123
### 13. Дайте роль readonly пользователю testread
### 14. Зайдите под пользователем testread в базу данных testdb
### 15. Сделайте select * from t1;
### 16. Получилось? (могло если вы делали сами не по шпаргалке и не упустили один существенный момент про который позже)
### 17. Напишите что именно произошло в тексте домашнего задания
### 18. У вас есть идеи почему? ведь права то дали?
### 19. Посмотрите на список таблиц
### 20. Подсказка в шпаргалке под пунктом 20
### 21. А почему так получилось с таблицей (если делали сами и без шпаргалки то может у вас все нормально)
### 22. Вернитесь в базу данных testdb под пользователем postgres
### 23. Удалите таблицу t1
### 24. Создайте ее заново но уже с явным указанием имени схемы testnm
### 25. Вставьте строку со значением c1=1
### 26. Зайдите под пользователем testread в базу данных testdb
### 27. Сделайте select * from testnm.t1;
### 28. Получилось?
### 29. Есть идеи почему? если нет - смотрите шпаргалку
### 30. Как сделать так чтобы такое больше не повторялось? если нет идей - смотрите шпаргалку
### 31. Сделайте select * from testnm.t1;
### 32. Получилось?
### 33. Есть идеи почему? если нет - смотрите шпаргалку
### 34. Сделайте select * from testnm.t1;
### 35. Получилось?
### 36. Ура!
### 37. Теперь попробуйте выполнить команду create table t2(c1 integer); insert into t2 values (2);
### 38. А как так? нам же никто прав на создание таблиц и insert в них под ролью readonly?
### 39. Есть идеи как убрать эти права? если нет - смотрите шпаргалку
### 40. Если вы справились сами то расскажите что сделали и почему, если смотрели шпаргалку - объясните что сделали и почему, выполнив указанные в ней команды
### 41. Теперь попробуйте выполнить команду create table t3(c1 integer); insert into t2 values (2);
### 42. Расскажите что получилось и почему
